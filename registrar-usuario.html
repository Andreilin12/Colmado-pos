<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Usuarios</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: #ecf0f1;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .register-container {
      background: rgba(44, 62, 80, 0.9);
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      width: 100%;
      max-width: 600px;
    }

    .register-container h2 {
      margin-bottom: 20px;
      color: #16e086;
      text-align: center;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.1);
      color: #ecf0f1;
      font-size: 16px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.2);
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .photo-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }

    .photo-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 10px;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .photo-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-preview i {
      font-size: 40px;
      color: #95a5a6;
    }

    .upload-btn {
      background: #16e086;
      color: white;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .upload-btn:hover {
      background: #15a086;
    }

    .register-btn {
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      border: none;
      border-radius: 5px;
      background: #16e086;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .register-btn:hover {
      background: #15a086;
    }

    .error-message {
      color: #ff7675;
      margin-top: 5px;
      font-size: 14px;
      display: none;
    }

    .success-message {
      color: #16e086;
      margin-top: 15px;
      text-align: center;
      display: none;
    }

    .loading {
      display: none;
      text-align: center;
      margin-top: 15px;
    }

    .loading i {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="register-container">
    <h2><i class="fas fa-user-plus"></i> Registrar Nuevo Usuario</h2>
    
    <div class="photo-upload">
      <div class="photo-preview" id="photoPreview">
        <i class="fas fa-user"></i>
      </div>
      <input type="file" id="photoInput" accept="image/*" style="display: none;">
      <button class="upload-btn" id="uploadBtn"><i class="fas fa-upload"></i> Subir Foto</button>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="fullName">Nombre Completo</label>
        <input type="text" id="fullName" placeholder="Ej: Juan Pérez">
        <div class="error-message" id="fullNameError">Este campo es requerido</div>
      </div>
      
      <div class="form-group">
        <label for="cedula">Cédula</label>
        <input type="text" id="cedula" placeholder="Ej: 001-1234567-8">
        <div class="error-message" id="cedulaError">Este campo es requerido</div>
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="gender">Sexo</label>
        <select id="gender">
          <option value="">Seleccionar...</option>
          <option value="Masculino">Masculino</option>
          <option value="Femenino">Femenino</option>
        </select>
        <div class="error-message" id="genderError">Este campo es requerido</div>
      </div>
      
      <div class="form-group">
        <label for="phone">Teléfono</label>
        <input type="tel" id="phone" placeholder="Ej: 809-123-4567">
        <div class="error-message" id="phoneError">Este campo es requerido</div>
      </div>
    </div>
    
    <div class="form-group">
      <label for="address">Dirección</label>
      <textarea id="address" rows="2" placeholder="Dirección completa"></textarea>
      <div class="error-message" id="addressError">Este campo es requerido</div>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="position">Posición</label>
        <input type="text" id="position" placeholder="Ej: Vendedor">
        <div class="error-message" id="positionError">Este campo es requerido</div>
      </div>
      
      <div class="form-group">
        <label for="company">Empresa</label>
        <input type="text" id="company" placeholder="Nombre de la empresa">
        <div class="error-message" id="companyError">Este campo es requerido</div>
      </div>
    </div>
    
    <div class="form-group">
      <label for="workplace">Lugar de Trabajo</label>
      <input type="text" id="workplace" placeholder="Ubicación física del trabajo">
      <div class="error-message" id="workplaceError">Este campo es requerido</div>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="username">Usuario</label>
        <input type="text" id="username" placeholder="Nombre de usuario">
        <div class="error-message" id="usernameError">Este campo es requerido</div>
      </div>
      
      <div class="form-group">
        <label for="pin">PIN (4-9 dígitos)</label>
        <input type="password" id="pin" placeholder="••••" maxlength="9">
        <div class="error-message" id="pinError">El PIN debe tener entre 4 y 9 dígitos</div>
      </div>
    </div>
    
    <button class="register-btn" id="registerBtn">Registrar Usuario</button>
    
    <div class="success-message" id="successMessage">
      <i class="fas fa-check-circle"></i> Usuario registrado exitosamente!
    </div>
    
    <div class="loading" id="loading">
      <i class="fas fa-spinner"></i> Registrando usuario...
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      createUserWithEmailAndPassword 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      addDoc,
      doc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { 
      getStorage, 
      ref, 
      uploadBytes, 
      getDownloadURL 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
      authDomain: "inventario-35d6b.firebaseapp.com",
      projectId: "inventario-35d6b",
      storageBucket: "inventario-35d6b.appspot.com",
      messagingSenderId: "266100399659",
      appId: "1:266100399659:web:92358d28cbd803c8a7d46e",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Elementos del DOM
    const photoPreview = document.getElementById('photoPreview');
    const photoInput = document.getElementById('photoInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const registerBtn = document.getElementById('registerBtn');
    const successMessage = document.getElementById('successMessage');
    const loading = document.getElementById('loading');

    // Campos del formulario
    const fullName = document.getElementById('fullName');
    const cedula = document.getElementById('cedula');
    const gender = document.getElementById('gender');
    const phone = document.getElementById('phone');
    const address = document.getElementById('address');
    const position = document.getElementById('position');
    const company = document.getElementById('company');
    const workplace = document.getElementById('workplace');
    const username = document.getElementById('username');
    const pin = document.getElementById('pin');

    // Mensajes de error
    const fullNameError = document.getElementById('fullNameError');
    const cedulaError = document.getElementById('cedulaError');
    const genderError = document.getElementById('genderError');
    const phoneError = document.getElementById('phoneError');
    const addressError = document.getElementById('addressError');
    const positionError = document.getElementById('positionError');
    const companyError = document.getElementById('companyError');
    const workplaceError = document.getElementById('workplaceError');
    const usernameError = document.getElementById('usernameError');
    const pinError = document.getElementById('pinError');

    // Variables globales
    let currentUser = null;
    let photoFile = null;

    // Observador de autenticación
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
      } else {
        // Redirigir a login si no hay usuario autenticado
        window.location.href = 'login.html';
      }
    });

    // Subir foto de perfil
    uploadBtn.addEventListener('click', () => {
      photoInput.click();
    });

    photoInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        photoFile = file;
        const reader = new FileReader();
        reader.onload = (event) => {
          photoPreview.innerHTML = `<img src="${event.target.result}" alt="Foto de perfil">`;
        };
        reader.readAsDataURL(file);
      }
    });

    // Validar formulario
    function validateForm() {
      let isValid = true;

      // Resetear errores
      document.querySelectorAll('.error-message').forEach(el => {
        el.style.display = 'none';
      });

      // Validar campos requeridos
      if (!fullName.value.trim()) {
        fullNameError.style.display = 'block';
        isValid = false;
      }

      if (!cedula.value.trim()) {
        cedulaError.style.display = 'block';
        isValid = false;
      }

      if (!gender.value) {
        genderError.style.display = 'block';
        isValid = false;
      }

      if (!phone.value.trim()) {
        phoneError.style.display = 'block';
        isValid = false;
      }

      if (!address.value.trim()) {
        addressError.style.display = 'block';
        isValid = false;
      }

      if (!position.value.trim()) {
        positionError.style.display = 'block';
        isValid = false;
      }

      if (!company.value.trim()) {
        companyError.style.display = 'block';
        isValid = false;
      }

      if (!workplace.value.trim()) {
        workplaceError.style.display = 'block';
        isValid = false;
      }

      if (!username.value.trim()) {
        usernameError.style.display = 'block';
        isValid = false;
      }

      // Validar PIN (4-9 dígitos)
      if (!pin.value.match(/^\d{4,9}$/)) {
        pinError.style.display = 'block';
        isValid = false;
      }

      return isValid;
    }

    // Registrar usuario
    registerBtn.addEventListener('click', async () => {
      if (!validateForm()) return;

      loading.style.display = 'block';
      registerBtn.disabled = true;

      try {
        // 1. Subir foto de perfil si existe
        let photoUrl = '';
        if (photoFile) {
          const storageRef = ref(storage, `profile_photos/${Date.now()}_${photoFile.name}`);
          await uploadBytes(storageRef, photoFile);
          photoUrl = await getDownloadURL(storageRef);
        }

        // 2. Crear usuario en Firebase Auth (usamos email temporal)
        const email = `${username.value}@${company.value.replace(/\s+/g, '').toLowerCase()}.com`;
        const password = pin.value; // Usamos el PIN como contraseña
        
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const newUser = userCredential.user;

        // 3. Guardar datos adicionales en Firestore
        const userData = {
          fullName: fullName.value.trim(),
          cedula: cedula.value.trim(),
          gender: gender.value,
          phone: phone.value.trim(),
          address: address.value.trim(),
          position: position.value.trim(),
          company: company.value.trim(),
          workplace: workplace.value.trim(),
          username: username.value.trim(),
          pin: pin.value,
          photoUrl: photoUrl || '',
          registeredBy: currentUser.uid,
          registrationDate: new Date().toISOString(),
          role: 'user', // Rol por defecto
          active: true
        };

        // Guardar en la colección de usuarios
        await setDoc(doc(db, "users", newUser.uid), userData);

        // Guardar en la subcolección del usuario que lo registró
        await addDoc(collection(db, "users", currentUser.uid, "registeredUsers"), {
          userId: newUser.uid,
          ...userData
        });

        // Mostrar mensaje de éxito
        successMessage.style.display = 'block';
        loading.style.display = 'none';

        // Limpiar formulario después de 2 segundos
        setTimeout(() => {
          document.querySelector('form').reset();
          photoPreview.innerHTML = '<i class="fas fa-user"></i>';
          photoFile = null;
          successMessage.style.display = 'none';
          registerBtn.disabled = false;
        }, 2000);

      } catch (error) {
        console.error("Error al registrar usuario:", error);
        loading.style.display = 'none';
        registerBtn.disabled = false;
        
        // Mostrar error específico
        if (error.code === 'auth/email-already-in-use') {
          usernameError.textContent = 'Este nombre de usuario ya está en uso';
          usernameError.style.display = 'block';
        } else {
          alert('Error al registrar usuario: ' + error.message);
        }
      }
    });
  </script>
</body>
</html>
